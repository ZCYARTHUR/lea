<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>LEA åŠ¨ç”» Â· DOM å¤šæ¨¡å¼ + GPU ç²’å­å­—å½¢åœºï¼ˆæ­£å‘/ç™½åº•ï¼‰</title>
<style>
  :root{ --btn-bg:#000; --btn-fg:#fff; --menu-bg:rgba(0,0,0,.85); --menu-fg:#fff; }
  html,body{height:100%;margin:0;overflow:hidden;background:#fff;color:#000;-webkit-user-select:none;user-select:none}

  /* DOM èˆå°ï¼ˆé GPU æ¨¡å¼å¯ç”¨ï¼›é»˜è®¤éšè—ï¼‰ */
  #stage{position:relative;width:100vw;height:100vh;overflow:hidden;background:#fff;visibility:hidden}

  /* GPU èˆå° */
  #gpuRoot{position:fixed; inset:0; display:block; background:#fff}
  #gpuCanvas{position:absolute; inset:0; width:100%; height:100%; display:block}
  #gpuDiag{position:fixed; left:10px; bottom:10px; color:#64748b; font:12px/1.2 system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Helvetica,Arial; z-index:9; opacity:.9}

  /* é¡¶éƒ¨å·¥å…·æ¡ */
  .toolbar{position:fixed; right:12px; top:12px; z-index:9999; display:flex; gap:8px}
  .btn{padding:8px 12px; border-radius:999px; border:0; background:var(--btn-bg); color:var(--btn-fg); font-size:14px; opacity:.9; cursor:pointer}
  .btn:hover{opacity:1}
  .menu{position:absolute; right:0; top:44px; min-width:200px; background:var(--menu-bg); color:var(--menu-fg); border-radius:12px; overflow:hidden; display:none; z-index:10000; box-shadow:0 10px 30px rgba(0,0,0,.25); backdrop-filter:blur(8px)}
  .menu.open{display:block}
  .menu button{display:block;width:100%;text-align:left;padding:10px 14px;background:transparent;color:#fff;border:0;cursor:pointer;font-size:14px}
  .menu button:hover{background:rgba(255,255,255,.08)}

  /* DOM å¼¹çª—å…ƒç´ ï¼ˆä¿ç•™å ä½ï¼‰ */
  .tile{position:absolute; display:flex; align-items:center; justify-content:center;
    border-radius:10px; padding:0 6px; box-sizing:border-box;
    font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Segoe UI",Arial,Helvetica,sans-serif;
    line-height:1.1; text-align:center; word-break:break-word;
    box-shadow:0 2px 8px rgba(0,0,0,.12); will-change:transform,opacity; cursor:pointer;}

  /* è‡ªåŠ¨æ’­æ”¾å…œåº•æç¤º */
  .unlock-mask{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:10001; background:rgba(255,255,255,0)}
  .unlock-mask.show{ display:flex; }
  .unlock-card{background:rgba(0,0,0,.65); color:#fff; padding:10px 14px; border-radius:12px; font-size:14px; box-shadow:0 6px 24px rgba(0,0,0,.25)}
</style>
</head>
<body>
  <!-- DOM èˆå° -->
  <div id="stage"></div>

  <!-- GPU èˆå° -->
  <div id="gpuRoot"><canvas id="gpuCanvas"></canvas></div>
  <div id="gpuDiag" aria-hidden="true"></div>

  <!-- éŸ³ä¹ -->
  <audio id="bgm" preload="auto" loop autoplay playsinline>
    <source src="lea.mp3" type="audio/mpeg">
  </audio>

  <!-- é¡¶éƒ¨å·¥å…·æ  -->
  <div class="toolbar">
    <button id="modeBtn" class="btn" aria-haspopup="true" aria-expanded="false">æ¨¡å¼ï¼šGPU å­—å½¢ç²’å­</button>
    <button id="clearBtn" class="btn">æ¸…å±</button>
    <button id="textBtn" class="btn">å­—ï¼šLEA</button>

    <button id="musicBtn" class="btn">éŸ³ä¹ï¼šæš‚åœ</button>
    <div id="musicMenu" class="menu" aria-label="éŸ³ä¹èœå•">
      <div style="padding:10px 14px">
        <div style="display:flex;align-items:center;gap:8px">
          <span style="color:#bbb;font-size:12px;width:36px">éŸ³é‡</span>
          <input id="musicVol" type="range" min="0" max="1" step="0.01" value="0.6" style="width:120px">
          <button id="muteBtn" class="btn" style="padding:6px 10px;font-size:12px;background:#333">é™éŸ³</button>
        </div>
      </div>
    </div>

    <div id="modeMenu" class="menu" aria-label="æ¨¡å¼èœå•" role="menu">
      <button data-mode="GPU">GPU å­—å½¢ç²’å­ï¼ˆé«˜æ€§èƒ½ï¼‰</button>
      <div style="border-top:1px solid rgba(255,255,255,.12);margin:6px 0"></div>
      <button data-mode="LEA">LEA å­—å½¢ + å¼¹çª—</button>
      <button data-mode="HEART_RAIN">å¿ƒå½¢é›¨</button>
      <button data-mode="FIREWORKS">çƒŸèŠ±</button>
      <button data-mode="SNOW">é›ªèŠ±</button>
      <button data-mode="BALLOONS">æ°”çƒä¸Šæµ®</button>
      <button data-mode="CONFETTI">Confetti</button>
    </div>
  </div>

  <!-- è‡ªåŠ¨æ’­æ”¾å…œåº•æç¤º -->
  <div id="unlockMask" class="unlock-mask"><div class="unlock-card">ğŸ”Š è½»è§¦å±å¹•å¼€å¯éŸ³ä¹</div></div>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';

/* -------------------- éŸ³ä¹æ§åˆ¶ -------------------- */
const bgm = document.getElementById('bgm');
const musicBtn = document.getElementById('musicBtn');
const musicMenu = document.getElementById('musicMenu');
const volSlider = document.getElementById('musicVol');
const muteBtn = document.getElementById('muteBtn');
const unlockMask = document.getElementById('unlockMask');

try{ const lastVol = localStorage.getItem('bgm.volume'); bgm.volume = lastVol!==null ? Math.max(0,Math.min(1,parseFloat(lastVol))) : 0.6; volSlider.value = String(bgm.volume); }catch(e){}
async function autoStartBgm(){
  try{ bgm.muted=false; await bgm.play(); musicBtn.textContent='éŸ³ä¹ï¼šæš‚åœ'; unlockMask.classList.remove('show'); }
  catch(e){
    unlockMask.classList.add('show');
    const once = async()=>{ unlockMask.classList.remove('show'); document.removeEventListener('pointerdown', once, {capture:true}); try{ await bgm.play(); musicBtn.textContent='éŸ³ä¹ï¼šæš‚åœ'; }catch(_){} };
    document.addEventListener('pointerdown', once, {once:true, capture:true});
  }
}
function togglePlay(){ if(bgm.paused){ bgm.play(); musicBtn.textContent='éŸ³ä¹ï¼šæš‚åœ'; } else { bgm.pause(); musicBtn.textContent='éŸ³ä¹ï¼šæ’­æ”¾'; } }
musicBtn.addEventListener('click', ()=> musicMenu.classList.toggle('open'));
document.addEventListener('click', (e)=>{ if(!musicMenu.contains(e.target) && e.target!==musicBtn) musicMenu.classList.remove('open');});
volSlider.addEventListener('input', (e)=>{ const v = parseFloat(e.target.value); bgm.volume = isNaN(v)?0.6:v; try{localStorage.setItem('bgm.volume', String(bgm.volume));}catch(_){}} );
muteBtn.addEventListener('click', ()=>{ bgm.muted = !bgm.muted; muteBtn.textContent = bgm.muted?'å–æ¶ˆé™éŸ³':'é™éŸ³';});
autoStartBgm();

/* -------------------- GPU ç²’å­å­—å½¢åœº -------------------- */
const gpuRoot   = document.getElementById('gpuRoot');
const gpuCanvas = document.getElementById('gpuCanvas');
const gpuDiag   = document.getElementById('gpuDiag');

const GPUPARAM = {
  COUNT: 60000,
  BASE_SIZE: 0.012,
  DAMPING: 0.92,
  DRIVE: 0.28,
  EDGE_THR: 0.5,
  NOISE: 0.004,
  ENERGY_SCALE: 1.7,
  MASK_W: 1024,
  MASK_H: 512,
  PALETTE: ['#d946ef','#0ea5e9','#10b981','#0ea5e9','#111827','#f59e0b'] // ç™½åº•æ›´æ˜¾çœ¼
};

const GPU = {
  renderer:null, scene:null, camera:null,
  compScene:null, compCam:null, compMat:null,
  renderMat:null, inst:null,
  maskCanvas:null, maskTex:null,
  rtA:null, rtB:null, readRT:null, writeRT:null, stateTex:null,
  texSide:0, running:false, last:0, text:'LEA',
  audio:{ ctx:null, src:null, analyser:null, data:null, energy(){ if(!this.analyser) return 0; this.analyser.getByteFrequencyData(this.data); let s=0; for(const v of this.data) s+=v; return s/(this.data.length*255);} }
};

function initGPU(){
  if(GPU.renderer) return;

  const gl = gpuCanvas.getContext('webgl2', {antialias:true, alpha:false}); // alpha=false æ›´çº¯ç™½
  GPU.renderer = new THREE.WebGLRenderer({canvas:gpuCanvas, context:gl});
  GPU.renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
  GPU.renderer.setSize(innerWidth, innerHeight);
  GPU.renderer.setClearColor(0xffffff, 1); // â† ç™½è‰²æ¸…å±

  if(!GPU.renderer.capabilities.isWebGL2){ alert('éœ€è¦ WebGL2'); }
  if(!gl.getExtension('EXT_color_buffer_float')){ alert('éœ€è¦ EXT_color_buffer_float'); }

  GPU.scene  = new THREE.Scene();
  GPU.camera = new THREE.OrthographicCamera(-1,1,1,-1,-10,10);

  // æ–‡æœ¬é®ç½©
  GPU.maskCanvas = document.createElement('canvas');
  GPU.maskCanvas.width = GPUPARAM.MASK_W; GPU.maskCanvas.height = GPUPARAM.MASK_H;
  GPU.maskTex = new THREE.CanvasTexture(GPU.maskCanvas);
  GPU.maskTex.minFilter = THREE.LinearFilter; 
  GPU.maskTex.magFilter = THREE.LinearFilter;
  GPU.maskTex.flipY = true;           // â† å…³é”®ï¼šç¿»è½¬åˆ° OpenGL åº•è¾¹ä¸º 0 çš„åæ ‡ç³»
  GPU.maskTex.needsUpdate = true;

  // çŠ¶æ€çº¹ç†å°ºå¯¸
  GPU.texSide = Math.ceil(Math.sqrt(GPUPARAM.COUNT));
  function makeRT(){ return new THREE.WebGLRenderTarget(GPU.texSide, GPU.texSide, {
    type:THREE.FloatType, format:THREE.RGBAFormat, minFilter:THREE.NearestFilter, magFilter:THREE.NearestFilter, depthBuffer:false, stencilBuffer:false
  });}
  GPU.rtA = makeRT(); GPU.rtB = makeRT(); GPU.readRT = GPU.rtA; GPU.writeRT = GPU.rtB;

  // åˆå§‹åŒ–ç²’å­
  const initArr = new Float32Array(GPU.texSide*GPU.texSide*4);
  for(let i=0;i<GPUPARAM.COUNT;i++){
    const k=i*4;
    initArr[k]   = (Math.random()*2-1) * (innerWidth/innerHeight) * 0.95;
    initArr[k+1] = (Math.random()*2-1) * 0.95;
    initArr[k+2] = (Math.random()*2-1) * 0.02;
    initArr[k+3] = (Math.random()*2-1) * 0.02;
  }
  GPU.stateTex = new THREE.DataTexture(initArr, GPU.texSide, GPU.texSide, THREE.RGBAFormat, THREE.FloatType);
  GPU.stateTex.needsUpdate = true;

  // è®¡ç®— pass
  const quadGeom = new THREE.PlaneGeometry(2,2);
  GPU.compMat = new THREE.RawShaderMaterial({
    glslVersion: THREE.GLSL3,
    uniforms: {
      prevTex:   { value: GPU.stateTex },
      maskTex:   { value: GPU.maskTex },
      uTexSize:  { value: new THREE.Vector2(GPU.texSide, GPU.texSide) },
      uMaskSize: { value: new THREE.Vector2(GPUPARAM.MASK_W, GPUPARAM.MASK_H) },
      uAspect:   { value: innerWidth/innerHeight },
      uDt:       { value: 0.016 },
      uTime:     { value: 0 },
      uDrive:    { value: GPUPARAM.DRIVE },
      uDamping:  { value: GPUPARAM.DAMPING },
      uNoise:    { value: GPUPARAM.NOISE },
      uEdgeThr:  { value: GPUPARAM.EDGE_THR },
      uEnergy:   { value: 0.0 }
    },
    vertexShader: `
      precision highp float;
      in vec3 position; out vec2 vUv;
      void main(){ vUv = position.xy*0.5+0.5; gl_Position = vec4(position,1.0); }
    `,
    fragmentShader: `
      precision highp float; precision highp sampler2D;
      in vec2 vUv; out vec4 outColor;
      uniform sampler2D prevTex;   // (x,y,vx,vy)
      uniform sampler2D maskTex;   // æ–‡æœ¬ alpha
      uniform vec2 uTexSize, uMaskSize;
      uniform float uAspect, uDt, uTime, uDrive, uDamping, uNoise, uEdgeThr, uEnergy;

      float hash(vec2 p){ return fract(sin(dot(p, vec2(127.1,311.7))) * 43758.5453123); }
      float rand(vec2 p){ return hash(p + uTime*0.123); }

      // ä¸–ç•Œåæ ‡ -> é®ç½©åæ ‡ï¼ˆä¸ flipY=true é…å¥—ï¼Œæ–‡å­—æ­£å‘ï¼‰
      vec2 worldToMask(vec2 pos){
        float u = (pos.x / uAspect + 1.0) * 0.5;
        float v = (pos.y + 1.0) * 0.5;   // æ­£å‘ï¼ˆä¸å† 1.0 - ...ï¼‰
        return vec2(u, v);
      }

      vec3 sampleAlphaGrad(vec2 pos){
        vec2 uv = worldToMask(pos);
        vec2 dp = 1.0 / uMaskSize;
        float a  = texture(maskTex, uv).a;
        float ax = texture(maskTex, uv + vec2(dp.x,0.0)).a - texture(maskTex, uv - vec2(dp.x,0.0)).a;
        float ay = texture(maskTex, uv + vec2(0.0,dp.y)).a - texture(maskTex, uv - vec2(0.0,dp.y)).a;
        return vec3(a, ax*0.5, ay*0.5);
      }

      void main(){
        vec4 s = texture(prevTex, vUv);
        vec2 pos = s.xy; vec2 vel = s.zw;

        vec3 ag = sampleAlphaGrad(pos);
        float a = ag.x; vec2 grad = vec2(ag.y, ag.z);
        float sgn = (a < uEdgeThr) ? 1.0 : -0.5;
        vec2 F = sgn * grad * uDrive * (0.5 + uEnergy);

        vec2 N = (vec2(rand(vUv+0.37), rand(vUv+0.79))*2.0-1.0) * uNoise * (0.6 + uEnergy);

        vel = (vel + F) * uDamping + N;
        pos += vel * uDt;

        float X = uAspect * 0.98;
        if(pos.x < -X){ pos.x=-X; vel.x*=-0.4; }
        if(pos.x >  X){ pos.x= X; vel.x*=-0.4; }
        if(pos.y < -0.98){ pos.y=-0.98; vel.y*=-0.4; }
        if(pos.y >  0.98){ pos.y= 0.98; vel.y*=-0.4; }

        outColor = vec4(pos, vel);
      }
    `
  });
  GPU.compScene = new THREE.Scene();
  GPU.compCam   = new THREE.OrthographicCamera(-1,1,1,-1,-1,1);
  GPU.compScene.add(new THREE.Mesh(quadGeom, GPU.compMat));

  // æ¸²æŸ“ passï¼ˆInstanced Meshï¼‰
  const quad = new THREE.PlaneGeometry(1,1);
  GPU.renderMat = new THREE.RawShaderMaterial({
    glslVersion: THREE.GLSL3,
    uniforms: {
      posTex:   { value: GPU.readRT?.texture },
      uTexSize: { value: new THREE.Vector2(GPU.texSide, GPU.texSide) },
      uAspect:  { value: innerWidth/innerHeight },
      uSize:    { value: GPUPARAM.BASE_SIZE },
      uEnergy:  { value: 0.0 },
      uP0: { value: new THREE.Color(GPUPARAM.PALETTE[0]) },
      uP1: { value: new THREE.Color(GPUPARAM.PALETTE[1]) },
      uP2: { value: new THREE.Color(GPUPARAM.PALETTE[2]) },
      uP3: { value: new THREE.Color(GPUPARAM.PALETTE[3]) },
      uP4: { value: new THREE.Color(GPUPARAM.PALETTE[4]) },
      uP5: { value: new THREE.Color(GPUPARAM.PALETTE[5]) }
    },
    vertexShader: `
      precision highp float; precision highp sampler2D;
      uniform sampler2D posTex; uniform vec2 uTexSize; uniform float uAspect; uniform float uSize; uniform float uEnergy;
      in vec3 position; // [-0.5,0.5] quad
      out float vColIndex;
      out vec2 vLocal;
      void main(){
        int tw = int(uTexSize.x);
        int i = gl_InstanceID;
        int x = i % tw; int y = i / tw;
        vec2 uv = (vec2(float(x), float(y)) + 0.5) / uTexSize;
        vec4 s = texture(posTex, uv);
        vec2 pos = s.xy;

        float size = uSize * (1.0 + uEnergy*0.6);
        vec2 p = pos + position.xy * size;

        vColIndex = float(i % 6);
        vLocal = position.xy;
        gl_Position = vec4(p.x / uAspect, p.y, 0.0, 1.0);
      }
    `,
    fragmentShader: `
      precision highp float;
      in float vColIndex;
      in vec2 vLocal;
      out vec4 outColor;
      uniform vec3 uP0; uniform vec3 uP1; uniform vec3 uP2;
      uniform vec3 uP3; uniform vec3 uP4; uniform vec3 uP5;
      vec3 pick(float i){
        int k=int(i+0.5);
        return (k==0)?uP0:(k==1)?uP1:(k==2)?uP2:(k==3)?uP3:(k==4)?uP4:uP5;
      }
      void main(){
        float r = length(vLocal);
        float alpha = smoothstep(0.5, 0.42, r);
        vec3 col = pick(vColIndex);
        outColor = vec4(col, alpha);
      }
    `,
    transparent:true
  });
  GPU.inst = new THREE.InstancedMesh(quad, GPU.renderMat, GPUPARAM.COUNT);
  GPU.inst.frustumCulled = false;
  GPU.scene.add(GPU.inst);

  // éŸ³é¢‘èƒ½é‡
  try{
    GPU.audio.ctx = new (window.AudioContext||window.webkitAudioContext)();
    GPU.audio.src = GPU.audio.ctx.createMediaElementSource(bgm);
    GPU.audio.analyser = GPU.audio.ctx.createAnalyser();
    GPU.audio.analyser.fftSize = 256; GPU.audio.data = new Uint8Array(GPU.audio.analyser.frequencyBinCount);
    GPU.audio.src.connect(GPU.audio.analyser).connect(GPU.audio.ctx.destination);
  }catch(e){ console.warn('Audio context init failed', e); }

  // è‡ªé€‚åº”
  addEventListener('resize', ()=>{
    GPU.renderer.setSize(innerWidth, innerHeight);
    GPU.renderMat.uniforms.uAspect.value = innerWidth/innerHeight;
    GPU.compMat.uniforms.uAspect.value = innerWidth/innerHeight;
  });
}

function drawTextMask(text){
  const c = GPU.maskCanvas, mctx = c.getContext('2d');
  const W=c.width, H=c.height;
  mctx.clearRect(0,0,W,H);
  mctx.fillStyle='#000'; // åœ¨ç™½åº•ä¸‹æˆ‘ä»¬å¸Œæœ›å­—å½¢åŠ›åœºæ¥è‡ªâ€œé»‘/ä¸é€æ˜ alphaâ€
  mctx.fillRect(0,0,W,H); // å…ˆé“ºåº•é»‘
  mctx.globalCompositeOperation = 'destination-out'; // ç”¨æ–‡å­—â€œæŒ–ç©ºâ€å¾—åˆ° alpha å½¢çŠ¶
  mctx.fillStyle='#fff';
  let fontSize = Math.floor(H*0.74);
  mctx.font = `700 ${fontSize}px system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Helvetica,Arial`;
  let metrics = mctx.measureText(text);
  while(metrics.width > W*0.88 && fontSize>14){
    fontSize-=4; mctx.font = `700 ${fontSize}px system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Helvetica,Arial`;
    metrics = mctx.measureText(text);
  }
  mctx.textAlign='center'; mctx.textBaseline='middle';
  const x=W/2, y=H/2 + (metrics.actualBoundingBoxDescent - metrics.actualBoundingBoxAscent)/2;
  mctx.fillText(text, x, y);
  mctx.globalCompositeOperation = 'source-over';
  GPU.maskTex.needsUpdate = true;
}

function computeStep(dt, energy){
  GPU.compMat.uniforms.uDt.value = dt;
  GPU.compMat.uniforms.uTime.value += dt;
  GPU.compMat.uniforms.uEnergy.value = energy;
  GPU.compMat.uniforms.uAspect.value = innerWidth/innerHeight;
  GPU.compMat.uniforms.prevTex.value = GPU.stateTex ? GPU.stateTex : GPU.readRT.texture;

  GPU.renderer.setRenderTarget(GPU.writeRT);
  GPU.renderer.render(GPU.compScene, GPU.compCam);
  GPU.renderer.setRenderTarget(null);

  GPU.stateTex = null;
  const t = GPU.readRT; GPU.readRT = GPU.writeRT; GPU.writeRT = t;
}

function loop(t){
  if(!GPU.running) return;
  const now = t || performance.now();
  const dt = Math.min(0.04, (now - (GPU.last||now))/1000);
  GPU.last = now;

  const E = (GPU.audio.energy?.() || 0) * GPUPARAM.ENERGY_SCALE;
  computeStep(dt, E);
  GPU.renderMat.uniforms.posTex.value = GPU.readRT.texture;
  GPU.renderMat.uniforms.uEnergy.value = E;

  GPU.renderer.render(GPU.scene, GPU.camera);
  requestAnimationFrame(loop);
}

function startGPU(text){
  initGPU();
  GPU.text = (text||GPU.text||'LEA').slice(0,24);
  drawTextMask(GPU.text);
  GPU.running = true;
  GPU.last = performance.now();
  requestAnimationFrame(loop);
  document.getElementById('gpuDiag').textContent = `WebGL2 + GPGPU Â· Instanced(${GPUPARAM.COUNT}) Â· ç™½åº• Â· æ­£å‘`;
}
function stopGPU(){ GPU.running=false; }
function resetParticles(){
  const initArr = new Float32Array(GPU.texSide*GPU.texSide*4);
  for(let i=0;i<GPUPARAM.COUNT;i++){
    const k=i*4;
    initArr[k]   = (Math.random()*2-1) * (innerWidth/innerHeight) * 0.95;
    initArr[k+1] = (Math.random()*2-1) * 0.95;
    initArr[k+2] = (Math.random()*2-1) * 0.02;
    initArr[k+3] = (Math.random()*2-1) * 0.02;
  }
  GPU.stateTex = new THREE.DataTexture(initArr, GPU.texSide, GPU.texSide, THREE.RGBAFormat, THREE.FloatType);
  GPU.stateTex.needsUpdate = true;
}

/* -------------------- èœå•ä¸æ¨¡å¼åˆ‡æ¢ï¼ˆDOMæ¨¡å¼å ä½ï¼‰ -------------------- */
const STAGE = document.getElementById('stage');
function showGPU(show){ gpuRoot.style.display = show?'block':'none'; STAGE.style.visibility = show?'hidden':'visible'; }

const modeBtn = document.getElementById('modeBtn');
const modeMenu = document.getElementById('modeMenu');
const clearBtn = document.getElementById('clearBtn');
const textBtn  = document.getElementById('textBtn');

let CURRENT_MODE = 'GPU';
modeBtn.addEventListener('click', ()=>{ modeMenu.classList.toggle('open'); modeBtn.setAttribute('aria-expanded', modeMenu.classList.contains('open')?'true':'false'); });
document.addEventListener('click', (e)=>{ if(!modeMenu.contains(e.target) && e.target!==modeBtn){ modeMenu.classList.remove('open'); modeBtn.setAttribute('aria-expanded','false'); }});
modeMenu.addEventListener('click', (e)=>{
  const m = e.target.getAttribute('data-mode');
  if(!m) return;
  modeMenu.classList.remove('open'); modeBtn.setAttribute('aria-expanded','false');
  setMode(m);
});
clearBtn.addEventListener('click', ()=>{ if(CURRENT_MODE==='GPU') resetParticles(); else STAGE.innerHTML=''; });
textBtn.addEventListener('click', ()=>{
  const s = prompt('è¾“å…¥è¦æ˜¾ç¤ºçš„æ–‡æœ¬ï¼ˆæ”¯æŒä¸­è‹±æ–‡ï¼Œâ‰¤24 å­—ï¼‰', GPU.text);
  if(!s) return;
  GPU.text = s.slice(0,24);
  textBtn.textContent = 'å­—ï¼š' + GPU.text;
  if(CURRENT_MODE==='GPU') drawTextMask(GPU.text);
});

function setMode(m){
  CURRENT_MODE = m;
  modeBtn.textContent = 'æ¨¡å¼ï¼š' + ({GPU:'GPU å­—å½¢ç²’å­', LEA:'LEA å­—å½¢ + å¼¹çª—', HEART_RAIN:'å¿ƒå½¢é›¨', FIREWORKS:'çƒŸèŠ±', SNOW:'é›ªèŠ±', BALLOONS:'æ°”çƒä¸Šæµ®', CONFETTI:'Confetti'}[m]||m);

  if(m==='GPU'){ showGPU(true); startGPU(GPU.text); }
  else { stopGPU(); showGPU(false); /* è¿™é‡Œå¯æ¥ä½ çš„ DOM åŠ¨ç”» */ }
}

/* é»˜è®¤è¿› GPU æ¨¡å¼ */
setMode('GPU');

/* éŸ³ä¹æŒ‰é’®åŒå‡»å¿«æ·æ’­æ”¾/æš‚åœ */
musicMenu.addEventListener('dblclick', (e)=>e.stopPropagation());
musicBtn.addEventListener('dblclick', (e)=>{ e.preventDefault(); togglePlay(); });
</script>
</body>
</html>
