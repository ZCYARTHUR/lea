<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>LEA åŠ¨ç”» Â· å¤šæ¨¡å¼ï¼ˆè‡ªåŠ¨æ’­æ”¾éŸ³ä¹ï¼‰</title>
<style>
  :root{
    --btn-bg:#000; --btn-fg:#fff;
    --menu-bg:rgba(0,0,0,.85); --menu-fg:#fff;
  }
  html,body{height:100%;margin:0;padding:0;overflow:hidden;background:#fff;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}
  #stage{position:relative;width:100vw;height:100vh;overflow:hidden}

  /* å¡ç‰‡ï¼ˆå¼¹çª—ï¼‰ */
  .tile{
    position:absolute; display:flex; align-items:center; justify-content:center;
    border-radius:10px; padding:0 6px; box-sizing:border-box;
    font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Segoe UI",Arial,Helvetica,sans-serif;
    line-height:1.1; text-align:center; word-break:break-word;
    box-shadow:0 2px 8px rgba(0,0,0,.12);
    will-change:transform,opacity;
    cursor:pointer;
  }

  /* å³ä¸Šè§’æŒ‰é’®ä¸èœå• */
  .toolbar{position:fixed; right:12px; top:12px; z-index:9999; display:flex; gap:8px}
  .btn{
    padding:8px 12px; border-radius:999px; border:0; background:var(--btn-bg); color:var(--btn-fg);
    font-size:14px; opacity:.85; cursor:pointer
  }
  .btn:hover{opacity:1}
  .menu{
    position:absolute; right:0; top:44px; min-width:180px;
    background:var(--menu-bg); color:var(--menu-fg); border-radius:12px; overflow:hidden;
    display:none; z-index:10000; box-shadow:0 10px 30px rgba(0,0,0,.25); backdrop-filter: blur(8px);
  }
  .menu.open{display:block}
  .menu button{
    display:block; width:100%; text-align:left; padding:10px 14px; background:transparent; color:#fff; border:0; cursor:pointer; font-size:14px;
  }
  .menu button:hover{background:rgba(255,255,255,.08)}

  /* ç²’å­ï¼ˆå¿ƒ/çº¸å±‘/çƒŸèŠ±/é›ª/æ°”çƒï¼‰ */
  .particle{position:absolute; pointer-events:none; will-change:transform,opacity}
  .heart{font-size:16px; filter:drop-shadow(0 1px 2px rgba(0,0,0,.2))}
  .confetti{width:8px; height:12px; transform-origin:50% 50%; border-radius:2px}
  .snow{width:8px; height:8px; border-radius:50%; background:rgba(255,255,255,.95); box-shadow:0 0 10px rgba(255,255,255,.8)}
  .balloon{width:18px; height:24px; border-radius:50% 50% 50% 50% / 60% 60% 40% 40%; box-shadow:0 3px 10px rgba(0,0,0,.15)}

  /* éšè—ç¥ç¦æ ·å¼ */
  .secret{
    outline:2px dashed rgba(0,0,0,.2);
    box-shadow:0 6px 16px rgba(0,0,0,.18) !important;
  }

  /* è‡ªåŠ¨æ’­æ”¾è¢«æ‹¦æˆªæ—¶çš„â€œè½»è§¦å¼€å¯éŸ³ä¹â€è’™å±‚ */
  .unlock-mask{
    position:fixed; inset:0; display:none; align-items:center; justify-content:center;
    z-index:10001; background:rgba(255,255,255,0);
    -webkit-tap-highlight-color: transparent;
  }
  .unlock-mask.show{ display:flex; }
  .unlock-card{
    background:rgba(0,0,0,.65); color:#fff; padding:10px 14px; border-radius:12px;
    font-size:14px; box-shadow:0 6px 24px rgba(0,0,0,.25);
  }

  @media (prefers-reduced-motion: reduce) {
    .tile,.particle{animation:none !important}
  }
</style>
</head>
<body>
  <div id="stage"></div>

  <!-- è‡ªåŠ¨æ’­æ”¾ + å¾ªç¯ï¼›playsinline é¿å… iOS æ‹‰èµ·å…¨å±ï¼›preload æå‰ç¼“å†² -->
  <audio id="bgm" preload="auto" loop autoplay playsinline>
    <source src="lea.mp3" type="audio/mpeg">
  </audio>

  <!-- é¡¶éƒ¨å·¥å…·æ  -->
  <div class="toolbar">
    <button id="modeBtn" class="btn">æ¨¡å¼ï¼šLEA</button>
    <button id="closeAll" class="btn">æ¸…å±</button>

    <!-- éŸ³ä¹æŒ‰é’® + é¢æ¿ -->
    <button id="musicBtn" class="btn">éŸ³ä¹ï¼šæ’­æ”¾</button>
    <div id="musicMenu" class="menu" aria-label="éŸ³ä¹èœå•">
      <div style="padding:10px 14px">
        <div style="display:flex;align-items:center;gap:8px">
          <span style="color:#bbb;font-size:12px;width:36px">éŸ³é‡</span>
          <input id="musicVol" type="range" min="0" max="1" step="0.01" value="0.6" style="width:120px">
          <button id="muteBtn" class="btn" style="padding:6px 10px;font-size:12px;background:#333">é™éŸ³</button>
        </div>
      </div>
    </div>

    <div id="modeMenu" class="menu" aria-label="æ¨¡å¼èœå•">
      <button data-mode="LEA">LEA å­—å½¢ + å¼¹çª—</button>
      <button data-mode="HEART_RAIN">å¿ƒå½¢é›¨</button>
      <button data-mode="FIREWORKS">çƒŸèŠ±</button>
      <button data-mode="SNOW">é›ªèŠ±</button>
      <button data-mode="BALLOONS">æ°”çƒä¸Šæµ®</button>
      <button data-mode="CONFETTI">Confetti</button>
    </div>
  </div>

  <!-- è‡ªåŠ¨æ’­æ”¾å…œåº•æç¤º -->
  <div id="unlockMask" class="unlock-mask">
    <div class="unlock-card">ğŸ”Š è½»è§¦å±å¹•å¼€å¯éŸ³ä¹</div>
  </div>

<script>
/* ===================== å…¨å±€é…ç½® ===================== */
const WORD = "LEA";
const START_MS = 200;
const END_MS   = 20;
const JITTER_PX = 3;
const COVER_RATIO = 0.8;
const CELL_GAP = 4;
const LEA_FADE_MS = 260;

const WIN_W = 240;
const WIN_H = 64;
const JITTER_RATIO = 0.4;

const TIPS_SETS = [
  ['LeaæŒ‰æ—¶åƒé¥­~','leaä¿æŒå¾®ç¬‘å‘€','Leaæ—©ç‚¹å›å®¶~','è®°å¾—åƒæ°´æœ','Leaä½ å·²ç»å¾ˆæ£’äº†å‘€~','å¥½å¥½çˆ±è‡ªå·±','Leaç§‹æ‹›ä¸Šå²¸','æ¢¦æƒ³æˆçœŸ','Leaæ˜¥æ‹›ä¸Šå²¸','é¡ºé¡ºåˆ©åˆ©','LeaæŒ‰æ—¶åƒé¥­','æ„¿æ‰€æœ‰çƒ¦æ¼éƒ½æ¶ˆå¤±','åˆ«ç†¬å¤œ','Leaä»Šå¤©è¿‡å¾—å¼€å¿ƒå˜›','æ‚‰å°¼å¤©å†·äº†ï¼Œå¤šç©¿è¡£æœ'],
  ['ä»Šå¤©ä¹Ÿè¦å¼€å¿ƒ','å–æ°´ï¼','æ·±å‘¼å¸ä¸‰æ¬¡','æ—©ç‚¹ç¡åˆ«ç†¬å¤œ','ä½ å€¼å¾—æœ€å¥½çš„ä¸€åˆ‡','å°ç¡®å¹¸æ­£åœ¨è·¯ä¸Š','å»æ•£ä¸ªæ­¥å§','åšä¸€ä»¶å°å°ä½†æ­£ç¡®çš„äº‹'],
  ['ç¥ä½ ä¸€è·¯é¡ºé£','ä¸‡äº‹é¡ºåˆ©','æ‰€æ„¿çš†æˆçœŸ','å¹³å®‰å–œä¹','å¥½äº‹å‘ç”Ÿåœ¨ä»Šå¤©','å¥½è¿æ’é˜Ÿæ¥']
];
const PALETTES = [
  ['#ffd3e0','#bde0fe','#c7f9cc','#e9e5ff','#fff6b3','#ffcfb3'],
  ['#f9e2af','#a6e3a1','#f5c2e7','#cba6f7','#89dceb','#fab387'],
  ['#ffedd5','#d1fae5','#e0e7ff','#fef9c3','#fee2e2','#f1f5f9']
];
let TIPS = TIPS_SETS[0];
let BG_COLORS = PALETTES[0];

const FONT_5x7 = {
  'L': ["1....","1....","1....","1....","1....","1....","11111"],
  'E': ["11111","1....","1....","1111.","1....","1....","11111"],
  'A': [".111.","1...1","1...1","11111","1...1","1...1","1...1"],
  ' ': [".....",".....",".....",".....",".....",".....","....."],
};

const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
const randInt = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const choice = arr => arr[Math.floor(Math.random()*arr.length)];

/* è®¡æ—¶å™¨æ± ï¼Œåˆ‡æ¨¡å¼æ—¶ç»Ÿä¸€æ¸…ç† */
const timers = new Set();
const intervals = new Set();
function later(fn,ms){ const id=setTimeout(()=>{timers.delete(id); fn();},ms); timers.add(id); return id; }
function every(fn,ms){ const id=setInterval(fn,ms); intervals.add(id); return id; }
function clearAllTimers(){ for(const t of timers) clearTimeout(t); timers.clear(); for(const i of intervals) clearInterval(i); intervals.clear(); }

/* ===================== å·¥å…·ï¼šå»ºå¡ç‰‡/ç²’å­ ===================== */
function makeTile(stage, spec, text="", tag=null){
  const div = document.createElement('div');
  div.className = 'tile';
  div.dataset.tag = tag || '';
  div.style.left = spec.x + 'px';
  div.style.top  = spec.y + 'px';
  div.style.width  = spec.w + 'px';
  div.style.height = spec.h + 'px';
  div.style.background = choice(BG_COLORS);
  div.style.fontSize = Math.max(10, Math.floor(Math.min(spec.w,spec.h)/2.9)) + 'px';
  div.textContent = text;

  // ç‚¹å‡»å½©è›‹ï¼šå¿ƒ/çº¸å±‘
  const clickBurst = (e) => {
    const rect = div.getBoundingClientRect();
    const cx = rect.left + rect.width/2 + window.scrollX;
    const cy = rect.top  + rect.height/2 + window.scrollY;
    Math.random() < 0.5 ? burstHearts(cx, cy) : burstConfetti(cx, cy);
  };

  // é•¿æŒ‰å½©è›‹ï¼šéšè—ç¥ç¦
  let pressTimer=null, pressed=false;
  const onDown = (e)=>{
    pressed = true;
    pressTimer = setTimeout(()=>{
      if(pressed){
        div.classList.add('secret');
        div.textContent = choice(['ğŸ ä½ è¶…æ£’','ğŸ’– å°å°å¥½è¿å·²ç­¾æ”¶','ğŸŒŸ ä»Šæ—¥é™å®šå¥½å¿ƒæƒ…','ğŸ¯ ä¸€åˆ‡é¡ºåˆ©']);
        div.animate([{transform:'scale(1)'},{transform:'scale(1.06)'}], {duration:220, fill:'forwards', easing:'ease-out'});
      }
    }, 600);
  };
  const onUp = (e)=>{
    if(pressTimer){ clearTimeout(pressTimer); pressTimer=null; }
    if(pressed){
      if(!div.classList.contains('secret')) clickBurst(e);
    }
    pressed=false;
  };

  div.addEventListener('pointerdown', onDown);
  window.addEventListener('pointerup', onUp, {once:false});

  stage.appendChild(div);
  div.animate([{opacity:0,transform:'scale(0.92)'},{opacity:1,transform:'scale(1)'}], {duration:180, easing:'ease-out'});
  return div;
}

function spawnParticle(cls, styles, keyframes, options){
  const p = document.createElement('div');
  p.className = 'particle ' + cls;
  Object.assign(p.style, styles);
  document.getElementById('stage').appendChild(p);
  const anim = p.animate(keyframes, options);
  anim.onfinish = ()=>p.remove();
  return p;
}

function burstHearts(x,y,count=10){
  for(let i=0;i<count;i++){
    const ang = Math.random()*Math.PI*2;
    const dist = 10+Math.random()*24;
    const tx = x + Math.cos(ang)*dist;
    const ty = y + Math.sin(ang)*dist - 10;
    spawnParticle('heart', {left:x+'px', top:y+'px', color:choice(['#ff4d6d','#ff8fa3','#e03131','#f783ac'])}, [
      {transform:'translate(-50%,-50%) scale(0.8)', opacity:0.0},
      {transform:`translate(${tx-x-50}%, ${ty-y-50}%) scale(1.2)`, opacity:1, offset:.6},
      {transform:`translate(${tx-x-50}%, ${ty-y-70}%) scale(0.9)`, opacity:0}
    ], {duration:600+Math.random()*400, easing:'ease-out', fill:'forwards'}).textContent='â¤';
  }
}

function burstConfetti(x,y,count=14){
  for(let i=0;i<count;i++){
    const col = choice(['#f94144','#f3722c','#f9c74f','#90be6d','#577590','#f72585','#4cc9f0']);
    const rx = (Math.random()-0.5)*60;
    const ry = (Math.random()-0.5)*40;
    const rot = (Math.random()*720-360)+'deg';
    spawnParticle('confetti', {left:(x-4)+'px', top:(y-6)+'px', background:col}, [
      {transform:'translate(0,0) rotate(0)', opacity:1},
      {transform:`translate(${rx}px, ${40+ry}px) rotate(${rot})`, opacity:0}
    ], {duration:700+Math.random()*500, easing:'cubic-bezier(.2,.8,.2,1)', fill:'forwards'});
  }
}

/* ===================== LEA é˜¶æ®µ + æ»¡å±å¼¹çª— + äºŒæ¬¡æ¼”å‡º ===================== */
function buildMask(text, spaceCols=1){
  const rows = 7;
  const maskRows = Array(rows).fill("");
  const chars = [...text.toUpperCase()];
  chars.forEach((ch, idx) => {
    const pat = FONT_5x7[ch] || FONT_5x7[' '];
    for(let r=0;r<rows;r++){
      maskRows[r] += pat[r];
      if(idx !== chars.length-1) maskRows[r] += ".".repeat(spaceCols);
    }
  });
  return maskRows;
}

function collectLetterPositions(maskRows, sw, sh){
  const rows = maskRows.length;
  const cols = maskRows.reduce((m,row)=>Math.max(m,row.length),0);
  if(!cols) return {positions:[]};

  const totalWTarget = Math.floor(sw * COVER_RATIO);
  const pitchX = Math.max(12, Math.floor(totalWTarget / cols));
  const pitchY = Math.max(12, pitchX);

  const dotW = Math.max(10, pitchX - CELL_GAP);
  const dotH = Math.max(10, pitchY - CELL_GAP);

  const totalW = cols * pitchX;
  const totalH = rows * pitchY;

  const x0 = Math.floor((sw - totalW)/2);
  const y0 = Math.floor((sh - totalH)/3);

  const positions = [];
  for(let c=0;c<cols;c++){
    for(let r=0;r<rows;r++){
      const ch = (maskRows[r][c] ?? '.');
      if(ch==='1'){
        const jx = randInt(-JITTER_PX, JITTER_PX);
        const jy = randInt(-JITTER_PX, JITTER_PX);
        let x = x0 + c*pitchX + jx;
        let y = y0 + r*pitchY + jy;
        const w = dotW, h = dotH;
        x = clamp(x, 0, sw - w);
        y = clamp(y, 0, sh - h);
        positions.push({x,y,w,h});
      }
    }
  }
  return {positions};
}

function collectRandomPositions(sw, sh){
  const n_windows = Math.floor((sw * sh) / (WIN_W * WIN_H) * 1.5);
  const positions = [];
  for(let i=0;i<n_windows;i++){
    const jitter_w = Math.floor(WIN_W * JITTER_RATIO);
    const jitter_h = Math.floor(WIN_H * JITTER_RATIO);
    const w = WIN_W + randInt(-jitter_w, jitter_w);
    const h = WIN_H + randInt(-jitter_h, jitter_h);
    const x = randInt(0, Math.max(0, sw - w));
    const y = randInt(0, Math.max(0, sh - h));
    positions.push({x,y,w,h});
  }
  return positions.sort(()=>Math.random()-0.5);
}

function fadeOutAndRemove(elems, ms=LEA_FADE_MS){
  return new Promise(resolve=>{
    if(!elems || elems.length===0){ resolve(); return; }
    let done = 0;
    for(const el of elems){
      el.animate([{opacity:1,transform:'scale(1)'},{opacity:0,transform:'scale(0.9)'}], {duration:ms, easing:'ease-in'}).onfinish = ()=>{
        el.remove();
        if(++done === elems.length) resolve();
      };
    }
  });
}

async function runLetters(word="LEA"){
  const stage = document.getElementById('stage');
  Array.from(stage.querySelectorAll('.tile[data-tag="phase1"]')).forEach(n=>n.remove());

  const sw = stage.clientWidth, sh = stage.clientHeight;
  const mask = buildMask(word, 1);
  const {positions} = collectLetterPositions(mask, sw, sh);
  const total = positions.length;

  const created = [];
  await new Promise(res=>{
    let i = 0;
    (function spawn(){
      if(i>=total){ res(); return; }
      const p = (i+1)/total;
      const interval = Math.max(END_MS, Math.floor(START_MS*(1-p)*(1-p) + END_MS*p));
      created.push( makeTile(stage, positions[i], "", "phase1") );
      i++;
      later(spawn, interval);
    })();
  });

  await fadeOutAndRemove(created, LEA_FADE_MS);
}

function runFill(){
  const stage = document.getElementById('stage');
  const sw = stage.clientWidth, sh = stage.clientHeight;
  const positions = collectRandomPositions(sw, sh);
  const total = positions.length;
  let i = 0;
  (function spawn(){
    if(i>=total) return;
    const p = (i+1)/total;
    const interval = Math.max(END_MS, Math.floor(START_MS*(1-p)*(1-p) + END_MS*p));
    makeTile(stage, positions[i], choice(TIPS), "phase2");
    i++;
    later(spawn, interval);
  })();

  later(async ()=>{
    const cards = Array.from(stage.querySelectorAll('.tile[data-tag="phase2"]'));
    if(!cards.length) return;
    const pickN = Math.max(8, Math.floor(cards.length*0.25));
    const chosen = cards.sort(()=>Math.random()-0.5).slice(0, pickN);
    await new Promise(done=>{
      let finished = 0;
      chosen.forEach(el=>{
        el.animate(
          [{transform:'translateY(0) rotate(0)', opacity:1},
           {transform:`translateY(-40px) rotate(${randInt(-12,12)}deg)`, opacity:0}],
          {duration:500+Math.random()*300, easing:'ease-in'}
        ).onfinish=()=>{
          el.remove();
          if(++finished===chosen.length) done();
        };
      });
    });
    BG_COLORS = choice(PALETTES);
    TIPS = choice(TIPS_SETS);
    runFill();
  }, 800);
}

/* ===================== æ¨¡å¼ï¼šå¿ƒå½¢é›¨/çƒŸèŠ±/é›ªèŠ±/æ°”çƒ/Confetti ===================== */
function modeHeartRain(){
  const st = document.getElementById('stage');
  const spawn = ()=> {
    const x = randInt(20, st.clientWidth-20);
    const y = -20;
    const dur = 3000 + Math.random()*2000;
    const p = spawnParticle('heart', {left:x+'px', top:y+'px', color:choice(['#ff4d6d','#ff8fa3','#f06595','#e03131'])}, [
      {transform:'translate(-50%,-50%) scale(0.8)', opacity:0},
      {transform:`translate(-50%, ${st.clientHeight+40}px) scale(1.1)`, opacity:1}
    ], {duration:dur, easing:'linear', fill:'forwards'});
    p.textContent='â¤';
  };
  every(spawn, 120);
}

function modeSnow(){
  const st = document.getElementById('stage');
  const spawn = ()=> {
    const x = randInt(0, st.clientWidth);
    const size = randInt(6,12);
    const dur = 6000 + Math.random()*4000;
    spawnParticle('snow', {left:x+'px', top:'-10px', width:size+'px', height:size+'px', opacity:.9}, [
      {transform:`translateY(${st.clientHeight+20}px)` , opacity:.95},
      {opacity:0}
    ], {duration:dur, easing:'linear', fill:'forwards'});
  };
  every(spawn, 80);
}

function modeBalloons(){
  const st = document.getElementById('stage');
  const spawn = ()=> {
    const x = randInt(20, st.clientWidth-20);
    const clr = choice(['#ffadad','#ffd6a5','#fdffb6','#caffbf','#9bf6ff','#a0c4ff','#bdb2ff']);
    const dur = 6000 + Math.random()*4000;
    spawnParticle('balloon', {left:x+'px', bottom:'-30px', background:clr}, [
      {transform:'translate(-50%, 0)'},
      {transform:`translate(-50%, -${st.clientHeight+60}px)`, opacity:.2}
    ], {duration:dur, easing:'cubic-bezier(.25,.8,.2,1)', fill:'forwards'});
  };
  every(spawn, 280);
}

function modeConfetti(){
  const st = document.getElementById('stage');
  const spawn = ()=> {
    const x = randInt(0, st.clientWidth);
    const y = -10;
    const dur = 2500 + Math.random()*2000;
    const rot = (Math.random()*720-360)+'deg';
    spawnParticle('confetti', {left:x+'px', top:y+'px', background:choice(['#f94144','#f3722c','#f9c74f','#90be6d','#577590','#f72585','#4cc9f0'])}, [
      {transform:'translateY(0) rotate(0)', opacity:1},
      {transform:`translateY(${st.clientHeight+20}px) rotate(${rot})`, opacity:.9}
    ], {duration:dur, easing:'linear', fill:'forwards'});
  };
  every(spawn, 40);
}

function modeFireworks(){
  const st = document.getElementById('stage');
  const fire = ()=>{
    const cx = randInt(80, st.clientWidth-80);
    const cy = randInt(80, Math.max(120, st.clientHeight*0.6));
    const rocket = spawnParticle('particle', {left:cx+'px', top:(st.clientHeight+20)+'px', width:'2px', height:'12px', background:'#fff'}, [
      {transform:`translate(-50%, -${st.clientHeight - cy}px)`, opacity:1},
      {opacity:0}
    ], {duration:700, easing:'cubic-bezier(.3,.9,.2,1)', fill:'forwards'});
    later(()=>burstConfetti(cx, cy, 24), 680);
  };
  every(fire, 900);
}

/* ===================== æ¨¡å¼åˆ‡æ¢ä¸æ§åˆ¶ ===================== */
let CURRENT_MODE = 'LEA';

function closeAll(){
  clearAllTimers();
  const stage = document.getElementById('stage');
  stage.innerHTML = '';
}

async function startLEAFlow(){
  closeAll();
  BG_COLORS = PALETTES[0];
  TIPS = TIPS_SETS[0];
  await runLetters(WORD);
  runFill();

  let resizeTimer=null;
  const onResize = ()=>{
    clearTimeout(resizeTimer);
    resizeTimer = later(async ()=>{
      if(CURRENT_MODE!=='LEA') return;
      closeAll();
      await runLetters(WORD);
      runFill();
    }, 250);
  };
  window.addEventListener('resize', onResize, {once:false});
}

function setMode(m){
  CURRENT_MODE = m;
  document.getElementById('modeBtn').textContent = 'æ¨¡å¼ï¼š' + ({
    'LEA':'LEA','HEART_RAIN':'å¿ƒå½¢é›¨','FIREWORKS':'çƒŸèŠ±','SNOW':'é›ªèŠ±','BALLOONS':'æ°”çƒä¸Šæµ®','CONFETTI':'Confetti'
  }[m] || m);

  closeAll();
  if(m==='LEA'){ startLEAFlow(); return; }
  if(m==='HEART_RAIN'){ modeHeartRain(); return; }
  if(m==='FIREWORKS'){ modeFireworks(); return; }
  if(m==='SNOW'){ modeSnow(); return; }
  if(m==='BALLOONS'){ modeBalloons(); return; }
  if(m==='CONFETTI'){ modeConfetti(); return; }
}

/* ===================== é¡¶éƒ¨èœå•äº¤äº’ ===================== */
const modeBtn = document.getElementById('modeBtn');
const modeMenu = document.getElementById('modeMenu');
modeBtn.addEventListener('click', ()=>{ modeMenu.classList.toggle('open'); });
modeMenu.addEventListener('click', (e)=>{
  const m = e.target.getAttribute('data-mode');
  if(!m) return;
  modeMenu.classList.remove('open');
  setMode(m);
});
document.addEventListener('click', (e)=>{
  if(!modeMenu.contains(e.target) && e.target!==modeBtn){
    modeMenu.classList.remove('open');
  }
});
document.getElementById('closeAll').addEventListener('click', closeAll, {passive:true});

/* ===================== éŸ³ä¹æ§åˆ¶ï¼ˆè‡ªåŠ¨æ’­æ”¾ + å…œåº•è§£é” + èœå•ï¼‰ ===================== */
const bgm = document.getElementById('bgm');
const musicBtn = document.getElementById('musicBtn');
const musicMenu = document.getElementById('musicMenu');
const volSlider = document.getElementById('musicVol');
const muteBtn = document.getElementById('muteBtn');
const unlockMask = document.getElementById('unlockMask');

// åˆå§‹åŒ–éŸ³é‡
try {
  const lastVol = localStorage.getItem('bgm.volume');
  bgm.volume = lastVol !== null ? Math.min(1, Math.max(0, parseFloat(lastVol))) : 0.6;
  volSlider.value = String(bgm.volume);
} catch (_) { bgm.volume = 0.6; }

// è‡ªåŠ¨æ’­æ”¾å°è¯•
async function autoStartBgm(){
  try{
    bgm.muted = false;
    await bgm.play(); // è‹¥è¢«ç­–ç•¥æ‹¦æˆªï¼Œä¼šæŠ›å¼‚å¸¸
    musicBtn.textContent = 'éŸ³ä¹ï¼šæš‚åœ';
    unlockMask.classList.remove('show');
  }catch(e){
    // æ˜¾ç¤ºè’™å±‚æç¤ºç”¨æˆ·è½»è§¦è§£é”
    unlockMask.classList.add('show');
    const once = async ()=>{
      unlockMask.classList.remove('show');
      document.removeEventListener('pointerdown', once, {capture:true});
      try{ await bgm.play(); musicBtn.textContent='éŸ³ä¹ï¼šæš‚åœ'; }catch(_){}
    };
    document.addEventListener('pointerdown', once, {once:true, capture:true});
  }
}

async function togglePlay() {
  try {
    if (bgm.paused) {
      await bgm.play();
      musicBtn.textContent = 'éŸ³ä¹ï¼šæš‚åœ';
    } else {
      bgm.pause();
      musicBtn.textContent = 'éŸ³ä¹ï¼šæ’­æ”¾';
    }
  } catch (err) {
    alert('æ’­æ”¾å¤±è´¥ï¼šè¯·ç¡®è®¤ lea.mp3 å·²ä¸Šä¼ ä¸”è·¯å¾„æ­£ç¡®ã€‚');
    console.error(err);
  }
}

// çŸ­æŒ‰æ’­æ”¾/æš‚åœï¼›é•¿æŒ‰åªå¼€éŸ³é‡èœå•
let pressTimer = null, pressed = false;
musicBtn.addEventListener('pointerdown', () => {
  pressed = true;
  pressTimer = setTimeout(() => {
    if (pressed) musicMenu.classList.toggle('open');
  }, 400);
});
musicBtn.addEventListener('pointerup', async () => {
  if (pressTimer) clearTimeout(pressTimer);
  if (pressed && !musicMenu.classList.contains('open')) await togglePlay();
  pressed = false;
});

// ç‚¹å‡»ç©ºç™½å¤„å…³é—­éŸ³ä¹èœå•
document.addEventListener('click', (e) => {
  if (!musicMenu.contains(e.target) && e.target !== musicBtn) musicMenu.classList.remove('open');
});

// éŸ³é‡ä¸é™éŸ³
volSlider.addEventListener('input', (e) => {
  const v = parseFloat(e.target.value);
  bgm.volume = isNaN(v) ? 0.6 : v;
  try { localStorage.setItem('bgm.volume', String(bgm.volume)); } catch (_) {}
});
muteBtn.addEventListener('click', () => {
  bgm.muted = !bgm.muted;
  muteBtn.textContent = bgm.muted ? 'å–æ¶ˆé™éŸ³' : 'é™éŸ³';
});

// å¯åŠ¨
window.addEventListener('load', ()=>{
  setMode('LEA');
  musicBtn.textContent = bgm.paused ? 'éŸ³ä¹ï¼šæ’­æ”¾' : 'éŸ³ä¹ï¼šæš‚åœ';
  autoStartBgm(); // â† è¿›å…¥é¡µé¢å³å°è¯•æ’­æ”¾
});
</script>
</body>
</html>
