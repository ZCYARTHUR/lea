<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>LEA åŠ¨ç”» Â· DOM å¤šæ¨¡å¼ + GPU ç²’å­å­—å½¢åœºï¼ˆPointsä¿®å¤ç‰ˆï¼‰</title>
<link rel="icon" href="data:,">
<style>
  :root{ --btn-bg:#000; --btn-fg:#fff; --menu-bg:rgba(0,0,0,.85); --menu-fg:#fff; }
  html,body{height:100%;margin:0;overflow:hidden;background:#fff;-webkit-user-select:none;user-select:none}
  #stage{position:relative;width:100vw;height:100vh;overflow:hidden}

  /* GPU å®¹å™¨ */
  #gpuRoot{position:fixed; inset:0; display:none; background:#0b0c10}
  #gpuCanvas{position:absolute; inset:0; width:100%; height:100%; display:block}
  #gpuDiag{position:fixed; left:10px; bottom:10px; color:#94a3b8; font:12px/1.2 system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Helvetica,Arial; z-index:9; opacity:.9}
  #maskPreview{position:fixed; left:10px; top:10px; width:220px; height:auto; z-index:9; display:none; border:1px solid rgba(255,255,255,.2)}

  /* å¡ç‰‡ */
  .tile{
    position:absolute; display:flex; align-items:center; justify-content:center;
    border-radius:10px; padding:0 6px; box-sizing:border-box;
    font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","Segoe UI",Arial,Helvetica,sans-serif;
    line-height:1.1; text-align:center; word-break:break-word;
    box-shadow:0 2px 8px rgba(0,0,0,.12); will-change:transform,opacity; cursor:pointer;
  }

  /* å·¥å…·æ  */
  .toolbar{position:fixed; right:12px; top:12px; z-index:9999; display:flex; gap:8px}
  .btn{ padding:8px 12px; border-radius:999px; border:0; background:var(--btn-bg); color:var(--btn-fg); font-size:14px; opacity:.9; cursor:pointer }
  .btn:hover{opacity:1}
  .menu{
    position:absolute; right:0; top:44px; min-width:200px; background:var(--menu-bg); color:var(--menu-fg);
    border-radius:12px; overflow:hidden; display:none; z-index:10000; box-shadow:0 10px 30px rgba(0,0,0,.25); backdrop-filter: blur(8px);
  }
  .menu.open{display:block}
  .menu button{ display:block; width:100%; text-align:left; padding:10px 14px; background:transparent; color:#fff; border:0; cursor:pointer; font-size:14px; }
  .menu button:hover{background:rgba(255,255,255,.08)}

  /* ç²’å­ï¼ˆDOM æ¨¡å¼ï¼‰ */
  .particle{position:absolute; pointer-events:none; will-change:transform,opacity}
  .heart{font-size:16px; filter:drop-shadow(0 1px 2px rgba(0,0,0,.2))}
  .confetti{width:8px; height:12px; transform-origin:50% 50%; border-radius:2px}
  .snow{width:8px; height:8px; border-radius:50%; background:rgba(255,255,255,.95); box-shadow:0 0 10px rgba(255,255,255,.8)}
  .balloon{width:18px; height:24px; border-radius:50% 50% 50% 50% / 60% 60% 40% 40%; box-shadow:0 3px 10px rgba(0,0,0,.15)}
  .secret{ outline:2px dashed rgba(0,0,0,.2); box-shadow:0 6px 16px rgba(0,0,0,.18) !important; }

  /* éŸ³ä¹è§£é”è’™å±‚ */
  .unlock-mask{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:10001; background:rgba(255,255,255,0) }
  .unlock-mask.show{ display:flex; }
  .unlock-card{ background:rgba(0,0,0,.65); color:#fff; padding:10px 14px; border-radius:12px; font-size:14px; box-shadow:0 6px 24px rgba(0,0,0,.25) }

  @media (prefers-reduced-motion: reduce) { .tile,.particle{animation:none !important} }
</style>
</head>
<body>
  <!-- DOM åŠ¨ç”»èˆå° -->
  <div id="stage"></div>

  <!-- GPU ç²’å­å­—å½¢åœº -->
  <div id="gpuRoot"><canvas id="gpuCanvas"></canvas></div>
  <img id="maskPreview" alt="Mask Preview"/>
  <div id="gpuDiag" aria-hidden="true"></div>

  <!-- éŸ³ä¹ï¼ˆè‹¥æ²¡æœ‰ lea.mp3 å¯å…ˆåˆ é™¤æ•´ä¸ª audio å—ï¼‰ -->
  <audio id="bgm" preload="auto" loop autoplay playsinline>
    <source src="lea.mp3" type="audio/mpeg">
  </audio>

  <!-- å·¥å…·æ  -->
  <div class="toolbar">
    <button id="modeBtn" class="btn" aria-haspopup="true" aria-expanded="false">æ¨¡å¼ï¼šLEA</button>
    <button id="closeAll" class="btn">æ¸…å±</button>
    <button id="gpuTextBtn" class="btn" style="display:none">å­—ï¼šLEA</button>

    <button id="musicBtn" class="btn">éŸ³ä¹ï¼šæ’­æ”¾</button>
    <div id="musicMenu" class="menu" aria-label="éŸ³ä¹èœå•">
      <div style="padding:10px 14px">
        <div style="display:flex;align-items:center;gap:8px">
          <span style="color:#bbb;font-size:12px;width:36px">éŸ³é‡</span>
          <input id="musicVol" type="range" min="0" max="1" step="0.01" value="0.6" style="width:120px">
          <button id="muteBtn" class="btn" style="padding:6px 10px;font-size:12px;background:#333">é™éŸ³</button>
        </div>
      </div>
    </div>

    <div id="modeMenu" class="menu" aria-label="æ¨¡å¼èœå•" role="menu">
      <button data-mode="LEA">LEA å­—å½¢ + å¼¹çª—</button>
      <button data-mode="HEART_RAIN">å¿ƒå½¢é›¨</button>
      <button data-mode="FIREWORKS">çƒŸèŠ±</button>
      <button data-mode="SNOW">é›ªèŠ±</button>
      <button data-mode="BALLOONS">æ°”çƒä¸Šæµ®</button>
      <button data-mode="CONFETTI">Confetti</button>
      <div style="border-top:1px solid rgba(255,255,255,.12);"></div>
      <button data-mode="GPU">GPU å­—å½¢ç²’å­ï¼ˆé«˜æ€§èƒ½ï¼‰</button>
    </div>
  </div>

  <div id="unlockMask" class="unlock-mask"><div class="unlock-card">ğŸ”Š è½»è§¦å±å¹•å¼€å¯éŸ³ä¹</div></div>

<script type="module">
/* =============== ä½ çš„ DOM æ¨¡å¼ï¼šåŸåŠŸèƒ½ä¿ç•™ï¼Œç•¥å»æ³¨é‡Šä»¥ç¼©çŸ­ =============== */
const WORD="LEA", START_MS=200, END_MS=20, JITTER_PX=3, COVER_RATIO=.8, CELL_GAP=4, LEA_FADE_MS=260;
const WIN_W=240, WIN_H=64, JITTER_RATIO=.4;
const TIPS_SETS=[['LeaæŒ‰æ—¶åƒé¥­~','leaä¿æŒå¾®ç¬‘å‘€','Leaæ—©ç‚¹å›å®¶~','è®°å¾—åƒæ°´æœ','Leaä½ å·²ç»å¾ˆæ£’äº†å‘€~','å¥½å¥½çˆ±è‡ªå·±','Leaç§‹æ‹›ä¸Šå²¸','æ¢¦æƒ³æˆçœŸ','Leaæ˜¥æ‹›ä¸Šå²¸','é¡ºé¡ºåˆ©åˆ©','LeaæŒ‰æ—¶åƒé¥­','æ„¿æ‰€æœ‰çƒ¦æ¼éƒ½æ¶ˆå¤±','åˆ«ç†¬å¤œ','Leaä»Šå¤©è¿‡å¾—å¼€å¿ƒå˜›','æ‚‰å°¼å¤©å†·äº†ï¼Œå¤šç©¿è¡£æœ'],['ä»Šå¤©ä¹Ÿè¦å¼€å¿ƒ','å–æ°´ï¼','æ·±å‘¼å¸ä¸‰æ¬¡','æ—©ç‚¹ç¡åˆ«ç†¬å¤œ','ä½ å€¼å¾—æœ€å¥½çš„ä¸€åˆ‡','å°ç¡®å¹¸æ­£åœ¨è·¯ä¸Š','å»æ•£ä¸ªæ­¥å§','åšä¸€ä»¶å°å°ä½†æ­£ç¡®çš„äº‹'],['ç¥ä½ ä¸€è·¯é¡ºé£','ä¸‡äº‹é¡ºåˆ©','æ‰€æ„¿çš†æˆçœŸ','å¹³å®‰å–œä¹','å¥½äº‹å‘ç”Ÿåœ¨ä»Šå¤©','å¥½è¿æ’é˜Ÿæ¥']];
const PALETTES=[['#ffd3e0','#bde0fe','#c7f9cc','#e9e5ff','#fff6b3','#ffcfb3'],['#f9e2af','#a6e3a1','#f5c2e7','#cba6f7','#89dceb','#fab387'],['#ffedd5','#d1fae5','#e0e7ff','#fef9c3','#fee2e2','#f1f5f9']];
let TIPS=TIPS_SETS[0], BG_COLORS=PALETTES[0];
const FONT_5x7={'L':["1....","1....","1....","1....","1....","1....","11111"],'E':["11111","1....","1....","1111.","1....","1....","11111"],'A':[".111.","1...1","1...1","11111","1...1","1...1","1...1"],' ':[".....",".....",".....",".....",".....",".....","....."],};
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const randInt=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
const choice=a=>a[Math.floor(Math.random()*a.length)];
const timers=new Set(), intervals=new Set();
const later=(fn,ms)=>{const id=setTimeout(()=>{timers.delete(id);fn();},ms);timers.add(id);return id;}
const every=(fn,ms)=>{const id=setInterval(fn,ms);intervals.add(id);return id;}
function clearAllTimers(){for(const t of timers)clearTimeout(t);timers.clear();for(const i of intervals)clearInterval(i);intervals.clear();}
function makeTile(stage,spec,text="",tag=null){const d=document.createElement('div');d.className='tile';d.dataset.tag=tag||'';Object.assign(d.style,{left:spec.x+'px',top:spec.y+'px',width:spec.w+'px',height:spec.h+'px',background:choice(BG_COLORS),fontSize:Math.max(10,Math.floor(Math.min(spec.w,spec.h)/2.9))+'px'});d.textContent=text;let pt=null,p=false;const burst=()=>{const r=d.getBoundingClientRect();const cx=r.left+r.width/2+scrollX,cy=r.top+r.height/2+scrollY;Math.random()<.5?burstHearts(cx,cy):burstConfetti(cx,cy)};d.addEventListener('pointerdown',()=>{p=true;pt=setTimeout(()=>{if(p){d.classList.add('secret');d.textContent=choice(['ğŸ ä½ è¶…æ£’','ğŸ’– å°å°å¥½è¿å·²ç­¾æ”¶','ğŸŒŸ ä»Šæ—¥é™å®šå¥½å¿ƒæƒ…','ğŸ¯ ä¸€åˆ‡é¡ºåˆ©']);d.animate([{transform:'scale(1)'},{transform:'scale(1.06)'}],{duration:220,fill:'forwards',easing:'ease-out'});}},600)});addEventListener('pointerup',()=>{if(pt){clearTimeout(pt);pt=null;}if(p&&!d.classList.contains('secret'))burst();p=false;},{once:false});stage.appendChild(d);d.animate([{opacity:0,transform:'scale(.92)'},{opacity:1,transform:'scale(1)'}],{duration:180,easing:'ease-out'});return d;}
function spawnParticle(cls,styles,kf,opt){const p=document.createElement('div');p.className='particle '+cls;Object.assign(p.style,styles);document.getElementById('stage').appendChild(p);p.animate(kf,opt).onfinish=()=>p.remove();return p;}
function burstHearts(x,y,n=10){for(let i=0;i<n;i++){const a=Math.random()*Math.PI*2,dist=10+Math.random()*24,tx=x+Math.cos(a)*dist,ty=y+Math.sin(a)*dist-10;spawnParticle('heart',{left:x+'px',top:y+'px',color:choice(['#ff4d6d','#ff8fa3','#e03131','#f783ac'])},[{transform:'translate(-50%,-50%) scale(0.8)',opacity:0},{transform:`translate(${tx-x-50}%, ${ty-y-50}%) scale(1.2)`,opacity:1,offset:.6},{transform:`translate(${tx-x-50}%, ${ty-y-70}%) scale(0.9)`,opacity:0}],{duration:600+Math.random()*400,easing:'ease-out',fill:'forwards'}).textContent='â¤';}}
function burstConfetti(x,y,n=14){for(let i=0;i<n;i++){const col=choice(['#f94144','#f3722c','#f9c74f','#90be6d','#577590','#f72585','#4cc9f0']),rx=(Math.random()-.5)*60,ry=(Math.random()-.5)*40,rot=(Math.random()*720-360)+'deg';spawnParticle('confetti',{left:(x-4)+'px',top:(y-6)+'px',background:col},[{transform:'translate(0,0) rotate(0)',opacity:1},{transform:`translate(${rx}px, ${40+ry}px) rotate(${rot})`,opacity:0}],{duration:700+Math.random()*500,easing:'cubic-bezier(.2,.8,.2,1)',fill:'forwards'});}}
function buildMask(text,spaceCols=1){const rows=7,m=Array(rows).fill(""),chs=[...text.toUpperCase()];chs.forEach((ch,i)=>{const p=FONT_5x7[ch]||FONT_5x7[' '];for(let r=0;r<rows;r++){m[r]+=p[r];if(i!==chs.length-1)m[r]+=".".repeat(spaceCols);}});return m;}
function collectLetterPositions(maskRows,sw,sh){const rows=maskRows.length,cols=maskRows.reduce((m,row)=>Math.max(m,row.length),0);if(!cols)return{positions:[]};const totalW=Math.floor(sw*COVER_RATIO),pitchX=Math.max(12,Math.floor(totalW/cols)),pitchY=Math.max(12,pitchX);const dotW=Math.max(10,pitchX-CELL_GAP),dotH=Math.max(10,pitchY-CELL_GAP);const tw=cols*pitchX,th=rows*pitchY,x0=Math.floor((sw-tw)/2),y0=Math.floor((sh-th)/3);const ps=[];for(let c=0;c<cols;c++){for(let r=0;r<rows;r++){const ch=(maskRows[r][c]??'.');if(ch==='1'){const jx=randInt(-JITTER_PX,JITTER_PX),jy=randInt(-JITTER_PX,JITTER_PX);let x=x0+c*pitchX+jx,y=y0+r*pitchY+jy;const w=dotW,h=dotH;x=clamp(x,0,sw-w);y=clamp(y,0,sh-h);ps.push({x,y,w,h});}}}return{positions:ps};}
function collectRandomPositions(sw,sh){const n=Math.floor((sw*sh)/(WIN_W*WIN_H)*1.5),ps=[];for(let i=0;i<n;i++){const jw=Math.floor(WIN_W*JITTER_RATIO),jh=Math.floor(WIN_H*JITTER_RATIO);const w=WIN_W+randInt(-jw,jw),h=WIN_H+randInt(-jh,jh),x=randInt(0,Math.max(0,sw-w)),y=randInt(0,Math.max(0,sh-h));ps.push({x,y,w,h});}return ps.sort(()=>Math.random()-0.5);}
function fadeOutAndRemove(e,ms=LEA_FADE_MS){return new Promise(res=>{if(!e||!e.length){res();return;}let d=0;for(const el of e){el.animate([{opacity:1,transform:'scale(1)'},{opacity:0,transform:'scale(0.9)'}],{duration:ms,easing:'ease-in'}).onfinish=()=>{el.remove();if(++d===e.length)res();};}});}
async function runLetters(word="LEA"){const st=document.getElementById('stage');Array.from(st.querySelectorAll('.tile[data-tag="phase1"]')).forEach(n=>n.remove());const {clientWidth:sw,clientHeight:sh}=st;const {positions}=collectLetterPositions(buildMask(word,1),sw,sh);const tot=positions.length;const created=[];await new Promise(res=>{let i=0;(function spawn(){if(i>=tot){res();return;}const p=(i+1)/tot;const itv=Math.max(END_MS,Math.floor(START_MS*(1-p)*(1-p)+END_MS*p));created.push(makeTile(st,positions[i],"","phase1"));i++;later(spawn,itv);})();});await fadeOutAndRemove(created,LEA_FADE_MS);}
function runFill(){const st=document.getElementById('stage');const {clientWidth:sw,clientHeight:sh}=st;const ps=collectRandomPositions(sw,sh);const tot=ps.length;let i=0;(function spawn(){if(i>=tot)return;const p=(i+1)/tot;const itv=Math.max(END_MS,Math.floor(START_MS*(1-p)*(1-p)+END_MS*p));makeTile(st,ps[i],choice(TIPS),"phase2");i++;later(spawn,itv);})();later(async()=>{const cards=Array.from(st.querySelectorAll('.tile[data-tag="phase2"]'));if(!cards.length)return;const pickN=Math.max(8,Math.floor(cards.length*.25));const chosen=cards.sort(()=>Math.random()-.5).slice(0,pickN);await new Promise(d=>{let f=0;chosen.forEach(el=>{el.animate([{transform:'translateY(0) rotate(0)',opacity:1},{transform:`translateY(-40px) rotate(${randInt(-12,12)}deg)`,opacity:0}],{duration:500+Math.random()*300,easing:'ease-in'}).onfinish=()=>{el.remove();if(++f===chosen.length)d();};});});BG_COLORS=choice(PALETTES);TIPS=choice(TIPS_SETS);runFill();},800);}
function modeHeartRain(){const st=document.getElementById('stage');const spawn=()=>{const x=randInt(20,st.clientWidth-20),dur=3000+Math.random()*2000;const p=spawnParticle('heart',{left:x+'px',top:'-20px',color:choice(['#ff4d6d','#ff8fa3','#f06595','#e03131'])},[{transform:'translate(-50%,-50%) scale(0.8)',opacity:0},{transform:`translate(-50%, ${st.clientHeight+40}px)`,opacity:1}],{duration:dur,easing:'linear',fill:'forwards'});p.textContent='â¤';};every(spawn,120);}
function modeSnow(){const st=document.getElementById('stage');const spawn=()=>{const x=randInt(0,st.clientWidth),size=randInt(6,12),dur=6000+Math.random()*4000;spawnParticle('snow',{left:x+'px',top:'-10px',width:size+'px',height:size+'px',opacity:.9},[{transform:`translateY(${st.clientHeight+20}px)`,opacity:.95},{opacity:0}],{duration:dur,easing:'linear',fill:'forwards'});};every(spawn,80);}
function modeBalloons(){const st=document.getElementById('stage');const spawn=()=>{const x=randInt(20,st.clientWidth-20),clr=choice(['#ffadad','#ffd6a5','#fdffb6','#caffbf','#9bf6ff','#a0c4ff','#bdb2ff']),dur=6000+Math.random()*4000;spawnParticle('balloon',{left:x+'px',bottom:'-30px',background:clr},[{transform:'translate(-50%, 0)'},{transform:`translate(-50%, -${st.clientHeight+60}px)`,opacity:.2}],{duration:dur,easing:'cubic-bezier(.25,.8,.2,1)',fill:'forwards'});};every(spawn,280);}
function modeConfetti(){const st=document.getElementById('stage');const spawn=()=>{const x=randInt(0,st.clientWidth),dur=2500+Math.random()*2000,rot=(Math.random()*720-360)+'deg';spawnParticle('confetti',{left:x+'px',top:'-10px',background:choice(['#f94144','#f3722c','#f9c74f','#90be6d','#577590','#f72585','#4cc9f0'])},[{transform:'translateY(0) rotate(0)',opacity:1},{transform:`translateY(${st.clientHeight+20}px) rotate(${rot})`,opacity:.9}],{duration:dur,easing:'linear',fill:'forwards'});} ;every(spawn,40);}

/* =============== æ¨¡å¼åˆ‡æ¢ï¼ˆå« GPU é›†æˆï¼‰ =============== */
let CURRENT_MODE='LEA';
const gpuRoot=document.getElementById('gpuRoot');
const gpuTextBtn=document.getElementById('gpuTextBtn');
const gpuDiag=document.getElementById('gpuDiag');
const maskPreviewImg=document.getElementById('maskPreview');
function showGPU(b){gpuRoot.style.display=b?'block':'none';document.getElementById('stage').style.visibility=b?'hidden':'visible';gpuTextBtn.style.display=b?'inline-block':'none';}
async function startLEAFlow(){closeAll();showGPU(false);BG_COLORS=PALETTES[0];TIPS=TIPS_SETS[0];await runLetters(WORD);runFill();let t=null;const onR=()=>{clearTimeout(t);t=later(async()=>{if(CURRENT_MODE!=='LEA')return;closeAll();await runLetters(WORD);runFill();},250)};addEventListener('resize',onR,{once:false});}
function closeAll(){clearAllTimers();document.getElementById('stage').innerHTML='';}
function setMode(m){CURRENT_MODE=m;document.getElementById('modeBtn').textContent='æ¨¡å¼ï¼š'+({'LEA':'LEA','HEART_RAIN':'å¿ƒå½¢é›¨','FIREWORKS':'çƒŸèŠ±','SNOW':'é›ªèŠ±','BALLOONS':'æ°”çƒä¸Šæµ®','CONFETTI':'Confetti','GPU':'GPU å­—å½¢ç²’å­'}[m]||m);if(window.GPUGlyph&&window.GPUGlyph.stop){window.GPUGlyph.stop();}closeAll();if(m==='LEA'){startLEAFlow();return;}if(m==='HEART_RAIN'){showGPU(false);modeHeartRain();return;}if(m==='FIREWORKS'){showGPU(false);modeConfetti();return;}if(m==='SNOW'){showGPU(false);modeSnow();return;}if(m==='BALLOONS'){showGPU(false);modeBalloons();return;}if(m==='CONFETTI'){showGPU(false);modeConfetti();return;}if(m==='GPU'){showGPU(true);window.GPUGlyph?.start({text:WORD});return;}}
const modeBtn=document.getElementById('modeBtn');const modeMenu=document.getElementById('modeMenu');
modeBtn.addEventListener('click',()=>{modeMenu.classList.toggle('open');modeBtn.setAttribute('aria-expanded',modeMenu.classList.contains('open')?'true':'false');});
modeMenu.addEventListener('click',e=>{const m=e.target.getAttribute('data-mode');if(!m)return;modeMenu.classList.remove('open');modeBtn.setAttribute('aria-expanded','false');setMode(m);});
addEventListener('click',e=>{if(!modeMenu.contains(e.target)&&e.target!==modeBtn){modeMenu.classList.remove('open');modeBtn.setAttribute('aria-expanded','false');}});
document.getElementById('closeAll').addEventListener('click',()=>{if(CURRENT_MODE==='GPU'){window.GPUGlyph?.resetParticles?.();}else{closeAll();}},{passive:true});

/* ================== éŸ³ä¹æ§åˆ¶ ================== */
const bgm=document.getElementById('bgm');const musicBtn=document.getElementById('musicBtn');const musicMenu=document.getElementById('musicMenu');const volSlider=document.getElementById('musicVol');const muteBtn=document.getElementById('muteBtn');const unlockMask=document.getElementById('unlockMask');
try{const lastVol=localStorage.getItem('bgm.volume');bgm.volume=lastVol!==null?Math.min(1,Math.max(0,parseFloat(lastVol))):0.6;volSlider.value=String(bgm.volume);}catch(_){bgm.volume=0.6;}
async function autoStartBgm(){try{bgm.muted=false;await bgm.play();musicBtn.textContent='éŸ³ä¹ï¼šæš‚åœ';unlockMask.classList.remove('show');}catch(e){unlockMask.classList.add('show');const once=async()=>{unlockMask.classList.remove('show');removeEventListener('pointerdown',once,{capture:true});try{await bgm.play();musicBtn.textContent='éŸ³ä¹ï¼šæš‚åœ';}catch(_){}};addEventListener('pointerdown',once,{once:true,capture:true});}}
async function togglePlay(){try{if(bgm.paused){await bgm.play();musicBtn.textContent='éŸ³ä¹ï¼šæš‚åœ';}else{bgm.pause();musicBtn.textContent='éŸ³ä¹ï¼šæ’­æ”¾';}}catch(err){console.warn('éŸ³ä¹æ’­æ”¾å¤±è´¥ï¼ˆå¯èƒ½ 404ï¼‰ï¼š',err);alert('æ’­æ”¾å¤±è´¥ï¼šè¯·ç¡®è®¤ lea.mp3 å·²ä¸Šä¼ ä¸”è·¯å¾„æ­£ç¡®ã€‚');}}
let pressTimer=null, pressed=false;
musicBtn.addEventListener('pointerdown',()=>{pressed=true;pressTimer=setTimeout(()=>{if(pressed)musicMenu.classList.toggle('open');},400);});
musicBtn.addEventListener('pointerup',async()=>{if(pressTimer)clearTimeout(pressTimer);if(pressed&&!musicMenu.classList.contains('open'))await togglePlay();pressed=false;});
addEventListener('click',e=>{if(!musicMenu.contains(e.target)&&e.target!==musicBtn)musicMenu.classList.remove('open');});
volSlider.addEventListener('input',e=>{const v=parseFloat(e.target.value);bgm.volume=isNaN(v)?0.6:v;try{localStorage.setItem('bgm.volume',String(bgm.volume));}catch(_){}} );
muteBtn.addEventListener('click',()=>{bgm.muted=!bgm.muted;muteBtn.textContent=bgm.muted?'å–æ¶ˆé™éŸ³':'é™éŸ³';});

/* ================== GPU æ¨¡å—ï¼ˆWebGL2 + GPGPUï¼ŒPoints æ¸²æŸ“ï¼‰ ================== */
import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
THREE.Cache.enabled = true;

window.GPUGlyph = (function(){
  let renderer, scene, camera, rafId=0;
  let compScene, compCam, compMat, quadMesh;
  let renderMat, points;
  let readRT, writeRT, stateTex=null;
  let maskCanvas, mctx, maskTex, MASK_W=1024, MASK_H=512;
  let texSide, COUNT=40000, aspect=1, screenH=1;
  let analyser=null, audioData=null;
  const canvas=document.getElementById('gpuCanvas');
  const palette=['#ffd3e0','#bde0fe','#c7f9cc','#e9e5ff','#fff6b3','#ffcfb3'];
  function diag(txt){document.getElementById('gpuDiag').textContent=txt;}

  function checkCaps(){
    const gl=renderer.getContext();
    const wgl2=renderer.capabilities.isWebGL2;
    const ext=gl.getExtension('EXT_color_buffer_float');
    diag(`WebGL2: ${wgl2} Â· EXT_color_buffer_float: ${!!ext}`);
    if(!wgl2||!ext){alert('éœ€è¦ WebGL2 + EXT_color_buffer_floatã€‚è¯·ç”¨æ¡Œé¢ Chrome/Edge/Firefox æˆ–å‡çº§æµè§ˆå™¨ã€‚');}
  }
  function makeRT(){return new THREE.WebGLRenderTarget(texSide,texSide,{type:THREE.FloatType,format:THREE.RGBAFormat,minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,depthBuffer:false,stencilBuffer:false});}
  function seedState(){const arr=new Float32Array(texSide*texSide*4);for(let i=0;i<COUNT;i++){const k=i*4;arr[k]=(Math.random()*2-1)*aspect*0.95;arr[k+1]=(Math.random()*2-1)*0.95;arr[k+2]=(Math.random()*2-1)*0.02;arr[k+3]=(Math.random()*2-1)*0.02;}const tex=new THREE.DataTexture(arr,texSide,texSide,THREE.RGBAFormat,THREE.FloatType);tex.needsUpdate=true;return tex;}
  function buildMaskCanvas(){maskCanvas=document.createElement('canvas');maskCanvas.width=MASK_W;maskCanvas.height=MASK_H;mctx=maskCanvas.getContext('2d');maskTex=new THREE.CanvasTexture(maskCanvas);maskTex.minFilter=THREE.LinearFilter;maskTex.magFilter=THREE.LinearFilter;}
  function drawTextMask(text){
    const W=MASK_W,H=MASK_H; mctx.clearRect(0,0,W,H); mctx.fillStyle='#fff';
    let fontSize=Math.floor(H*.72); mctx.font=`700 ${fontSize}px system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Helvetica,Arial`;
    let metrics=mctx.measureText(text);
    while(metrics.width>W*.85 && fontSize>12){fontSize-=4; mctx.font=`700 ${fontSize}px system-ui,-apple-system,Segoe UI,Roboto,PingFang SC,Helvetica,Arial`; metrics=mctx.measureText(text);}
    mctx.textAlign='center'; mctx.textBaseline='middle';
    const x=W/2, y=H/2 + (metrics.actualBoundingBoxDescent - metrics.actualBoundingBoxAscent)/2;
    mctx.fillText(text,x,y); maskTex.needsUpdate=true;
    const img=document.getElementById('maskPreview'); if(img.style.display==='block') img.src=maskCanvas.toDataURL();
  }

  function buildComputePass(){
    compScene=new THREE.Scene(); compCam=new THREE.OrthographicCamera(-1,1,1,-1,-1,1);
    const quadGeom=new THREE.PlaneGeometry(2,2);
    compMat=new THREE.ShaderMaterial({
      glslVersion:THREE.GLSL3,
      uniforms:{prevTex:{value:stateTex},maskTex:{value:maskTex},uTexSize:{value:new THREE.Vector2(texSide,texSide)},uMaskSize:{value:new THREE.Vector2(MASK_W,MASK_H)},uAspect:{value:aspect},uDt:{value:0.016},uTime:{value:0},uDrive:{value:0.28},uDamping:{value:0.92},uNoise:{value:0.004},uEdgeThr:{value:0.5},uEnergy:{value:0.0}},
      vertexShader:`out vec2 vUv; void main(){ vUv = position.xy*0.5+0.5; gl_Position = vec4(position,1.0); }`,
      fragmentShader:`
        precision highp float; precision highp sampler2D;
        in vec2 vUv; out vec4 outColor;
        uniform sampler2D prevTex, maskTex; uniform vec2 uTexSize, uMaskSize; 
        uniform float uAspect, uDt, uTime, uDrive, uDamping, uNoise, uEdgeThr, uEnergy;
        float hash(vec2 p){ return fract(sin(dot(p, vec2(127.1,311.7))) * 43758.5453123); }
        float rand(vec2 p){ return hash(p + uTime*0.123); }
        vec2 worldToMask(vec2 pos){ float u=(pos.x/uAspect+1.0)*0.5; float v=1.0-(pos.y+1.0)*0.5; return vec2(u,v); }
        vec3 sampleAlphaGrad(vec2 pos){
          vec2 uv=worldToMask(pos); vec2 dp=1.0/uMaskSize;
          float a=texture(maskTex,uv).a;
          float ax=texture(maskTex,uv+vec2(dp.x,0.0)).a - texture(maskTex,uv-vec2(dp.x,0.0)).a;
          float ay=texture(maskTex,uv+vec2(0.0,dp.y)).a - texture(maskTex,uv-vec2(0.0,dp.y)).a;
          return vec3(a,ax*.5,ay*.5);
        }
        void main(){
          vec4 s=texture(prevTex,vUv); vec2 pos=s.xy, vel=s.zw;
          vec3 ag=sampleAlphaGrad(pos); float a=ag.x; vec2 grad=ag.yz;
          float sgn=(a<uEdgeThr)?1.0:-0.5;
          vec2 F=sgn*grad*uDrive*(0.5+uEnergy);
          vec2 N=(vec2(rand(vUv+0.37),rand(vUv+0.79))*2.0-1.0)*uNoise*(0.6+uEnergy);
          vel=(vel+F)*uDamping+N; pos+=vel*uDt;
          float X=uAspect*0.98; if(pos.x<-X){pos.x=-X;vel.x*=-0.4;} if(pos.x>X){pos.x=X;vel.x*=-0.4;}
          if(pos.y<-0.98){pos.y=-0.98;vel.y*=-0.4;} if(pos.y>0.98){pos.y=0.98;vel.y*=-0.4;}
          outColor=vec4(pos,vel);
        }`
    });
    quadMesh=new THREE.Mesh(quadGeom, compMat); compScene.add(quadMesh);
  }

  function buildRenderPassPoints(){
    const geom=new THREE.BufferGeometry();
    // æä¾›ä¸€ä¸ªæœ€å°å±æ€§ï¼Œä½œä¸ºé¡¶ç‚¹è®¡æ•°ï¼ˆä¾èµ– aIndexï¼Œä¸å†ä½¿ç”¨ positionï¼‰
    const ids=new Float32Array(COUNT); for(let i=0;i<COUNT;i++) ids[i]=i;
    geom.setAttribute('aIndex', new THREE.BufferAttribute(ids,1));

    const cols=palette.map(c=> new THREE.Color(c));
    renderMat=new THREE.RawShaderMaterial({
      glslVersion:THREE.GLSL3,
      uniforms:{
        posTex:{value:readRT.texture}, uTexSize:{value:new THREE.Vector2(texSide,texSide)},
        uAspect:{value:aspect}, uSize:{value:0.012}, uEnergy:{value:0.0}, uScreenH:{value:screenH},
        uP0:{value:cols[0]}, uP1:{value:cols[1]}, uP2:{value:cols[2]}, uP3:{value:cols[3]}, uP4:{value:cols[4]}, uP5:{value:cols[5]},
      },
      vertexShader:`#version 300 es
        precision highp float; precision highp sampler2D;
        in float aIndex;
        uniform sampler2D posTex; uniform vec2 uTexSize; uniform float uAspect, uSize, uEnergy, uScreenH;
        flat out float vIndex;
        void main(){
          int id = int(aIndex);
          int tw = int(uTexSize.x);
          int x = id % tw; int y = id / tw;
          vec2 uv = (vec2(float(x), float(y)) + 0.5) / uTexSize;
          vec4 s = texture(posTex, uv);
          vec2 pos = s.xy;
          float size = uSize * (1.0 + uEnergy*0.6);
          gl_Position = vec4(pos.x / uAspect, pos.y, 0.0, 1.0);
          gl_PointSize = size * (uScreenH * 0.5);  // ä¸–ç•Œå•ä½ -> åƒç´ ï¼šä»¥å±å¹•é«˜åº¦ä¸ºåŸºå‡†
          vIndex = float(id % 6);
        }`,
      fragmentShader:`#version 300 es
        precision highp float;
        flat in float vIndex;
        uniform vec3 uP0,uP1,uP2,uP3,uP4,uP5;
        out vec4 outColor;
        vec3 pick(float i){
          int idx=int(i+0.5);
          if(idx==0) return uP0; else if(idx==1) return uP1; else if(idx==2) return uP2;
          else if(idx==3) return uP3; else if(idx==4) return uP4; else return uP5;
        }
        void main(){
          // åœ†å½¢è½¯è¾¹ç‚¹ç²¾çµ
          vec2 d = gl_PointCoord - vec2(0.5);
          float r = length(d);
          float alpha = smoothstep(0.5, 0.46, 0.5 - r);
          vec3 col = pick(vIndex);
          outColor = vec4(col, alpha*0.96);
          if(alpha <= 0.001) discard;
        }`,
      transparent:true, depthTest:false, depthWrite:false, blending:THREE.AdditiveBlending
    });
    points=new THREE.Points(geom, renderMat);
    points.frustumCulled=false;
    scene.add(points);
  }

  function computeStep(dt,energy){
    compMat.uniforms.uDt.value=dt; compMat.uniforms.uTime.value+=dt; compMat.uniforms.uEnergy.value=energy; compMat.uniforms.uAspect.value=aspect;
    compMat.uniforms.prevTex.value = stateTex ? stateTex : readRT.texture;
    renderer.setRenderTarget(writeRT); renderer.render(compScene, compCam); renderer.setRenderTarget(null);
    stateTex=null; const t=readRT; readRT=writeRT; writeRT=t;
  }
  function getEnergy(){ if(!analyser) return 0; analyser.getByteFrequencyData(audioData); let s=0; for(const v of audioData) s+=v; return Math.min(1, s/(audioData.length*255)); }
  function onResize(){
    const w=canvas.clientWidth, h=canvas.clientHeight;
    renderer.setSize(w,h,false);
    aspect=w/h; screenH=h*window.devicePixelRatio;
    if(compMat){ compMat.uniforms.uAspect.value=aspect; }
    if(renderMat){ renderMat.uniforms.uAspect.value=aspect; renderMat.uniforms.uScreenH.value=screenH; }
  }
  function toggleMaskPreview(){ const img=document.getElementById('maskPreview'); if(img.style.display==='block'){img.style.display='none';}else{img.src=maskCanvas.toDataURL(); img.style.display='block';} }

  async function start(opts){
    const text=(opts?.text||'LEA').toUpperCase(); document.getElementById('gpuTextBtn').textContent='å­—ï¼š'+text;
    if(!renderer){
      renderer=new THREE.WebGLRenderer({canvas, antialias:true, alpha:false, powerPreference:'high-performance'});
      renderer.debug.checkShaderErrors=true;
      renderer.setPixelRatio(Math.min(devicePixelRatio,2));
      renderer.setSize(gpuRoot.clientWidth,gpuRoot.clientHeight,false);
      renderer.setClearColor(0x0b0c10,1);

      scene=new THREE.Scene();
      camera=new THREE.OrthographicCamera(-1,1,1,-1,-10,10);

      try{const ctx=new (window.AudioContext||window.webkitAudioContext)();const src=ctx.createMediaElementSource(bgm);analyser=ctx.createAnalyser();analyser.fftSize=256;audioData=new Uint8Array(analyser.frequencyBinCount);src.connect(analyser).connect(ctx.destination);}catch(e){}
      checkCaps();
    }

    aspect=gpuRoot.clientWidth/gpuRoot.clientHeight;
    screenH=gpuRoot.clientHeight*window.devicePixelRatio;

    COUNT=Math.max(20000, COUNT|0);
    texSide=Math.ceil(Math.sqrt(COUNT));
    readRT=makeRT(); writeRT=makeRT(); stateTex=seedState();

    buildMaskCanvas(); drawTextMask(text);
    buildComputePass(); buildRenderPassPoints();
    onResize(); addEventListener('resize', onResize);

    const btn=document.getElementById('gpuTextBtn');
    btn.onclick=()=>{const val=prompt('è¾“å…¥è¦æ˜¾ç¤ºçš„æ–‡æœ¬ï¼ˆä¸è¶…è¿‡24å­—ç¬¦ï¼‰', text)||text; drawTextMask(val.toUpperCase()); btn.textContent='å­—ï¼š'+val.toUpperCase();};
    addEventListener('keydown', e=>{ if(e.key==='m'||e.key==='M') toggleMaskPreview(); });

    let last=performance.now();
    function loop(now){
      rafId=requestAnimationFrame(loop);
      const dt=Math.min(0.04,(now-last)/1000); last=now;
      const E=getEnergy()*1.7;
      computeStep(dt,E);
      renderMat.uniforms.posTex.value=readRT.texture;
      renderMat.uniforms.uEnergy.value=E;
      renderer.render(scene,camera);
    }
    rafId=requestAnimationFrame(loop);
    diag('GPU: OK Â· Points pipeline');
  }

  function stop(){
    cancelAnimationFrame(rafId); rafId=0; removeEventListener('resize', onResize);
    if(points){scene.remove(points);points.geometry.dispose();points.material.dispose();points=null;}
    if(compScene&&quadMesh){compScene.remove(quadMesh);quadMesh.geometry.dispose();quadMesh.material.dispose();quadMesh=null;}
    if(readRT){readRT.dispose();readRT=null;} if(writeRT){writeRT.dispose();writeRT=null;}
    stateTex=null; document.getElementById('gpuTextBtn').onclick=null; document.getElementById('maskPreview').style.display='none';
  }
  function resetParticles(){ stateTex=seedState(); }
  function setText(t){ drawTextMask(String(t||'LEA').toUpperCase()); document.getElementById('gpuTextBtn').textContent='å­—ï¼š'+String(t||'LEA').toUpperCase(); }
  return { start, stop, resetParticles, setText };
})();

/* =============== é¡µé¢å¯åŠ¨ =============== */
const modeBtn=document.getElementById('modeBtn');const musicBtn=document.getElementById('musicBtn');
window.addEventListener('load',()=>{ setMode('LEA'); musicBtn.textContent=document.getElementById('bgm').paused?'éŸ³ä¹ï¼šæ’­æ”¾':'éŸ³ä¹ï¼šæš‚åœ'; autoStartBgm(); });
</script>
</body>
</html>
